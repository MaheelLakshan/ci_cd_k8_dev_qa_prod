name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
    tags:
      - "[0-9]+.[0-9]+.[0-9]+-rc-*"
  release:
    types: [published, created]
  create:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+-rc-*"

permissions:
  contents: write

env:
  IMAGE_NAME: maheellakshan/python-cicd

jobs:
  metadata:
    name: Extract Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      environment: ${{ steps.info.outputs.environment }}
      docker_tag: ${{ steps.info.outputs.docker_tag }}
      should_skip: ${{ steps.check.outputs.should_skip }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if commit is from bot
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"Update"*"to"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: Commit is from GitHub Actions"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "Processing: User commit detected"
          fi

      - name: Extract info
        id: info
        if: steps.check.outputs.should_skip == 'false'
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Tag: 1.0.0-rc-qa
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=$(echo $TAG | sed -E 's/(.*)-rc-.*/\1/')
            ENV=$(echo $TAG | sed -E 's/.*-rc-(.*)/\1/')
            
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            echo "docker_tag=$TAG" >> $GITHUB_OUTPUT
          else
            # Branch: develop - use the CURRENT commit SHA
            SHORT_SHA=$(git rev-parse --short HEAD)
            
            echo "version=0.0.0" >> $GITHUB_OUTPUT
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "docker_tag=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: metadata
    if: needs.metadata.outputs.should_skip == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        run: |
          echo "Building image with tag: ${{ needs.metadata.outputs.docker_tag }}"
          docker build -t ${{ env.IMAGE_NAME }}:${{ needs.metadata.outputs.docker_tag }} ./app
          docker push ${{ env.IMAGE_NAME }}:${{ needs.metadata.outputs.docker_tag }}
          echo "Successfully pushed: ${{ env.IMAGE_NAME }}:${{ needs.metadata.outputs.docker_tag }}"

  update-manifest:
    name: Update K8s Manifest
    runs-on: ubuntu-latest
    needs: [metadata, build]
    if: needs.metadata.outputs.should_skip == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update deployment
        run: |
          ENV=${{ needs.metadata.outputs.environment }}
          TAG=${{ needs.metadata.outputs.docker_tag }}
          VER=${{ needs.metadata.outputs.version }}

          echo "Updating k8s/${ENV}/deployment.yaml"
          echo "New image tag: ${TAG}"
          echo "New version: ${VER}"

          sed -i "s|image: maheellakshan/python-cicd:.*|image: maheellakshan/python-cicd:${TAG}|g" k8s/${ENV}/deployment.yaml
          sed -i "s|value: \".*\" # VERSION|value: \"${VER}\" # VERSION|g" k8s/${ENV}/deployment.yaml

          echo "Manifest updated successfully"

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          ENV=${{ needs.metadata.outputs.environment }}
          TAG=${{ needs.metadata.outputs.docker_tag }}

          git add k8s/${ENV}/deployment.yaml

          if ! git diff --staged --quiet; then
            # Add [skip ci] to prevent infinite loop
            git commit -m "deploy: update ${ENV} to ${TAG} [skip ci]"
            
            if [[ "$ENV" == "dev" ]]; then
              git push origin HEAD:develop
            else
              git push origin HEAD:main
            fi
            
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
